variables:
  VPS_HOST: "brunohendias.com.br"
  IDENTITY_PROJECT: "*$CI_PROJECT_NAME CI_COMMIT_REF_NAME*"

stages:
  - prepare
  - test
  - analysis
  - build
  - deploy

cache:
  untracked: true
  paths:
    - ./app/node_modules/
    - ./app/vendor/

prepare_project:
  stage: prepare
  image: registry.gitlab.com/bruno_dias/gerence
  script:
    - cd ./app
    - echo "Configuring composer"
    - wget https://getcomposer.org/installer
    - php installer
    - echo "Running composer install"
    - php composer.phar install --no-dev --optimize-autolader --no-progress
    - cp .env.prod .env

Tests:
  stage: test
  image: registry.gitlab.com/bruno_dias/gerence
  dependencies:
    - prepare_project
  script:
    - echo "Runnit PHPUnit"
    - ./app/vendor/bin/phpunit

Static_Analysis:
  stage: analysis
  image: registry.gitlab.com/bruno_dias/gerence
  dependencies:
    - prepare_project
  script:
    - echo "Running Psalm"
    - ./app/vendor/bin/psalm --show-info=true

Build:
  stage: build
  image: registry.gitlab.com/bruno_dias/gerence
  dependencies:
    - prepare_project
  script:
    - cd ./app
    - echo "Running NPM"
    - npm install --no-progress
    - npm run prod --no-progress
  artifacts:
    paths:
      - ./app/public/css
      - ./app/public/js
      - ./app/public/mix-manifest.json
    expire_in: 1 days
    when: always


#Deploy:
  #stage: deploy
  #dependencies:
    #- Build
  #script:
    #- echo "Running Deploy"
    #- mkdir -p ~/.ssh
    #- chmod 700 ~/.ssh
